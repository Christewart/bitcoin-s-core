package org.bitcoins.core.serializers.transaction

import org.bitcoins.core.crypto.{ BEDoubleSha256Digest, DoubleSha256Digest }
import org.bitcoins.core.currency.{ Bitcoins, Satoshis }
import org.bitcoins.core.number.{ Int64, UInt32 }
import org.bitcoins.core.protocol.transaction.ZcashTransaction
import org.bitcoins.core.util.BitcoinSUtil
import org.scalatest.{ FlatSpec, MustMatchers }

/**
 * Created by str4d on 3/26/18.
 */
class RawZcashTransactionParserTest extends FlatSpec with MustMatchers {
  //txid 4070553dbcd801788e381692c8cf78cea3ed690ec93b359c5d91848dcc4e3a6c on mainnet
  val rawTxV1 = "0100000001a893a0260254d946c167489313dff73788296f9962d0b40e1cde113fe30fbff3420000006a47304402205c9ae87f0d58c7a22119c23a5a021d2de7c77ba33a89a1ec6bdc18a2c9f9e896022021abb54cba4ad854a7bf8e9f073f1e120ec841d8fcec6ebbc70fc7c4befdd7ed012102fed901cbe669b4ec65011f43f223fcf6efcf2316b2f3896318a9854e304d3916ffffffff0217f41400000000001976a914102f2ce538dcc3ccd1e268301abfca661c8f7b8c88acf5d39300000000001976a914bb30b068e30968de410b88d3e9b59f7fe012185688ac00000000"
  //txid bf1706af01f60f5347eac2291358def1467cae709223018c0bfff38732390c67 on mainnet
  val rawTxV2 = "020000000130838964c8dc456e2acd1eb2b30f33474e1dd4629476eaaddbcea93a8a319353000000006a47304402204f50c9c167ea4c96170e4967879487f372a9d40f8304615bc0431ea0cadd251402204deb2ca4d305aad404b5f50200b5186f224ab4bcb33d982d487102954af49a180121032806b2a6a5bd7c5567c5dd01660a0e918491b65c114a366eaa521c31ba412fffffffffff00000000000100d3b53b0000000000000000000000003468aa409524ea3365c4a95dea8cdf614ddc71193f1794d17d7a9fff50f1721a5102bbc88f1ea109ec1fd73b0181756cb8cab94fe748bb1f70bea435d756a918a00159aeaa981faeb7d9dae2f7cf372d3e07a8563c4cbc4b5666631c4984802cb96e065bf2e95fa0b5a4d0e48aadf116ea3e82bd79c71539a5dc0ba5405753109eb2913a136da76a29f65aa7cf388033fb5fb06cfad6f45d224e47466b680f63a91aa1b69a8f09d103fb6515b28bd38a6978ee1e9559f9bf757f37ccaa696a6d9ec328c46ae518c30cbb6520a2e6c9ed488e50005287146b44b769419f8f6734fd2fe082b75bf110a81ec79763c955041bac903dad4ec217fdfd708dffe4abb69a1335e553fcbe12dc3a1d2ad1569e029637ff052f262d201fc56b203235ab54021d83d73e05eb938a1645faf71f8320d89af20cbeab5607944b2343ad23efeb860221aaa9be2f9a80a8e9614405c7a8c735843c0611c2a5ff70ef200d450491ea4f0a03fd206593e047a2f955b998437a553119098600c02d43ff6264e0b4a45688bebcdd94921ab0da380ff9fbbd0987739ec2e99fdf56c51005d520450542e574f5030966a511ed982679e9f12a0f5a72ff005e6af4a4c7c94bb2ce3da94ca05437a102070e4c059e8d70f3f48534444c3139d469f6ee74f5a3575a09d86f430abc551b032b3899e40abde4623927023a83fb05f5b196671982a1a322bd6f8ada054249ed031a5e1bff4f196e923a129f0cf2f4d06c63b53c90e447d2043a3dc62466513332021aabf8470de83b8706b381e0a3953e72c480b7743af5d7da685e3b8d1f5d37c7101afff2ef754c94e0bd3fec7fb47f0c011ddf04e3be84991d6c17b80fedd2f8318013bd95abd02dc49904390dbb7ee9449a66bd7ea26b8ea54794dea40eade0cd9aa83455ac2052c18e8d7149f308a8976b2282022f0671f83059411d51b5231dba09b3f109baedb94a6221a64361788a62cb0c8eb72efa5b9b2c7e5a86e7a1f576814a3ef236cd692bd7c12051e9e619fb4b844646599db84c9eba55a35b0bf46f51f81ff7ca3b3667e93bdbd6e50ca87338fd63aff58d81411b499e38f6f3da7c13e5f8852a3d7276090d6764b85465bc7508fb930a1f6fa8e404509274b4fdb8fdf3bb7937459370d2405b2c285b3c238dfa63272fc197075622dabe1b4df223488488caf973686eb289eac33d6438bca5fd78b8eaf6249f8924c72d070fd8a53d8be3d63e4a532cb6b430028fee4bba7ca4f0cc42b13cd4a89e724ab578648f3b56a9a942bc0421030dc7c8a513ed636383e9c574ba154a1495478c0a99d3b03fbb335df62581b7d55861bd91d71b49af2434ce5ae824a826f7a5d4e44d966c2b6f0473e91d036c05c634b7e927d83d151b120bcd0569471eee83e2c9ed3078d4af143c4c74392fcfa5d3718740a8b81bac578bcf2fcf8d637dfd020a9273deae4302772a997fca6a74fc8a55109b5d94df2826b8428d4c718b7a952ad4420a289a5f759f41276355c49f66300826e35b557cc5935d4ec3c9eeb5e0910b583444d8f450b01acc8d39328cf2727c7fe650ed14567d769f48f612a9dca28623ff94478f3e5b5b5080414f943d09337d97ed104e1695ac8a73753aa30b5d584b685621d9316377e782d1a6d4b3d9e93702b263bf088fcc6144e4ba8776944083da9ebcc50a16c79136666711e653ffef09cf12561b8830cc4fec19942721343cf774a7eadd8a825494970d8365ed9b26813b4042fdb8fe08d99ff046552d31d44ed9211a7b034b3630125bc03d3a5b9416c399493bd139dd98648a0d02a714f713b9db69346dd6060758a4010a7e859bb32f4ee7af30e1c809e2d988a477b2e1a2e4832ff07548edec9283e8f9b8f7b2a67424fb58f91a9ed8b2bfe93e67f83ae9590b579845f8b367ed82dd7f88935f31ef4db3af11b03e3d20a207e4e37f43a15846244922e3dbed2ffb481cc33976055cf04d8147e525b3afd0c4f16f017bc728af8113906eafd366804b4ee63e60d84a6d65ce6732908a80c5cfd7bd7eff6cd13e46907dcbd06b6bc66428d749943bf1fb188668ff141a7257287f9c5211eb2b3f7c2f848ab0981d9f9c514adf90dce5d0aa3facfb27ee43690da1bbc1f828addd59c8d4cb139d848efc2b9ef8e6c6283c12f70f0405139501ec007eb17ae3c1d5bee74603171fcc02003b029ccf4cb6515f8358c0a5903c25374d58b872bcb9b88b4ffdfc7665105db80582ff2a34dae28b250a303896f52442e1c84f8ff3b43ceba0b48a1f868bab48760c77b41cdac6b4427f6dc6b120b8c589e1bff5c38b01e106728418cd0d0940701c30e3aff1b674b2a5c6c3bceb33e9a77071653d92a4b1a5e6d97ba366657db65fad2779a837a226a72bbe3fb540a0ebe1ade1287214a0b748d5ae3983fd17ca33f5f1f5be0fa7bb2da5b75f3a877bde2b2341a3b08781e7f7b7fcbafab3371f87323c37f1a74fd3898d880263bb329aca5357637bb4c468f74de3844e333bf4ab5e20a1f5b3a62ad932d7f80edb569fda18824b54b12417febac3e2feb1e784845b8632e76bb723e0485428662b787be701cd795b32716b135e059fe9cedcca67b05ddc6a6bdd74a0d70d094531858a4009edafc88aa6b760d22db6d720b4fa21a6630f"
  //txid ec6711f8250e1f7972789c937220fc1171e9e93052fc6f0e8e4955f6b5a47530 generated on regtest
  val rawTxV3 = "030000807082c403053378920ef8c26ea56e7f5a9de7a203c6fb9847fbf8e383c8768ae323348e7467000000006a47304402206bbcb28432c90b4857c217639e24745a04a571727385410925da6dfe83c9f24902204e9ce96cf04775e232116f654d19a5d9bb5b96a43916eedc2dce07c8d165f98f012103517f71860923ddae67d327009b14dd950b9fb00fb3abdd7726e9bed3a44ec401ffffffff68305870d8fbbacfe1bac3f02f6e7b631d9d4c9374f3745682dcbe337950ad29000000006a473044022003dbc4282d7a26a66d68a84a2dcfa351ba7a1e20a589d20d92f8fb3a3e759ef6022040bfe363bfb38e265f98cd1f624cc02de486f84d4e138b721261677b49c9c605012103517f71860923ddae67d327009b14dd950b9fb00fb3abdd7726e9bed3a44ec401ffffffff7a48d116bcc0ba9aefa5027b860fc8aac56a11b3832a2d3fcde9ddde08e694c6000000006b483045022100c9865925a2561a81994703d49e129b07c86355092bcb54801864dc3b2a37af5302204e646be31ec7d45a63200b3130912d3448433545bc35b2e95935e86f15e41390012103517f71860923ddae67d327009b14dd950b9fb00fb3abdd7726e9bed3a44ec401ffffffff7d69f7414e171b6cc5edf8b493ff266697fed91f7d73478c700b737bcf6b58f9000000006a473044022042afb65f4f07208430758d5649de32ec1f0c311e5fc78b27ab88e2b625ad6b61022070371785cba8450d8971aca47562c5231b39b1db0175c296dfca73f3854018d8012103517f71860923ddae67d327009b14dd950b9fb00fb3abdd7726e9bed3a44ec401ffffffff8c8e3f82e3000e19422899c5c1f7ab86b026db9abce7360b043a9c9a730a955e000000006b483045022100fec61c3dbb0e99b02d981f53dabe2a701a3f9e1738f8e966fd4c6a66cdf2221a022065a9433651056098a9393407a042051b5ddf31ecec9a08c830786bdaf60ac7c1012103517f71860923ddae67d327009b14dd950b9fb00fb3abdd7726e9bed3a44ec401ffffffff00000000007e00000001f0ca052a010000000000000000000000d7c612c817793191a1e68652121876d6b3bde40f4fa52bc314145ce6e5cdd2596e4264b49873bf31388cd8c9ee3f00837693efd06468528eed57fd77fd608a9c5752c0ed33194a73c9230e642ff34c8bd160fed162785895a4192c112b5dde95dcec953407ec721c3fbf4366a644b9b53c3661b3c2693119b8e3ea23c14bd6c73068eae27faa74b13099b2b7f3e823a1b2a36050ae9e9673170ca7b7e4803e9f0fa3fe1b3b10533e516a6c096cadbf5f0f61ba8b3fbde89969aafa6240483777981988863c8d2f0f24fa03aa8791fbca98bdb6a98b35615bb7ea61683e02e587faa255f0929d4fee7f997ac551d5ee0da82ea9dbb861be2c27e6a7fdd9b6eaacb5df76749a8a6be830126f1c33f167354bbafb4894568699fa3ffa88108495970320967d5859754bb2c1a82f24bf4024a5ac4a63b106c98d5a7eb2651bc36b8e2f022b02b614232c86017b20f63798aecf587fd9cf1c53c54f39e523371de2e6b4f70a02837c7a0ad12c3286b648028f286b5de6729581519660dbfebbfdf0ca39e6ff64675707689ff180664799c3a4c5fb20fc375a9ff475ec411fcca1eb2a243047030034b2a8ddc312399866554b3bdd0394399fd8aa02608f8cbdad1a99fa6aeffe032ebe864da9f4225a096ba338ef98c818823e18c9b32ab7f52857109dcff85f60020909418963470e5c57917370079fad3bd748c12a6b6b0eb697bc8dc46d4ade6802158fafa3b50a61ab0e1fa1221cbd96955ad2b88c3bc208e5ef1fc1c4b7302e8b030d2c842a1e4a49be8e200a63ac5228f6ef0b05770dab9ab15c77ea6a908e4718027213c722c0082cf827464173b6bf20418441dedec23e557ca99df55d53d2c1c198abb4d0a8679be13a49d2176aeebce895c9f00cee7fd037e922c43c6cd9f8e35f080a136fc035900b47e35fe524920d4829d74d5fa9aac9fd9f1dfe43e244265cb5329a61e92d972278ad9556ea36f32de1d62caf9115cdda7338c9439a8440ebc6e01602043c657e8e4a726aef55cbd33acd925a6da9a5d35d05da78b56b37d0cdcf5336c75a4611bdaf226398f215b9922318d17c280fceb39f24d8d86a22a0f399db66ede626df1c8bd4d21f5e78df62712ade348e20e37be1babc1c4572fa9b33c5bb8c0b844349ce0d8002bf133969b026d09ba1ccd1fb995eecc471ffeacece4416b44e45a7454a0b4f96dca6522bd072345cd35b6c92bb0daba9e83ccdedf5ee856fc0da65cd3c959175daeb9137cc7661c61f064fe31b6fc22a4651a2d1465484b9bd691da1233ca172b070081bb68a82277d62fcd9e1c1b391823976e588b87d4611228e61ffa8c4444ed96e19d64a984110d33b78ce8e108b8eb57004e483ce4f9212d451289a78a47fb642a795faab48fb9542399a956bf9ff7e0d6dba0419c6a3d9e0f61d35a674c1ab35935187d282fa6c9bc989c64e495d4d6ea140ce34b8c76658595659230038d52bca2f44a6a40c13865b89430d6b120489a0447a564a78e932f48cb6af0fedc264ed37bad016059da0ccaf2e6473bc856749a0bd3cfdc8c636cb40ac6f519457d0e79203a6acd72f32f9d499772df01d901e0231d522bbf2c9a9067e373c86f9e8d35cfe35463f6b686c6b6a5417d72854710e9ae9ff675d0bb5f4369d42247d53a15ab3bac20be5616185ffaa9b45774579245c38468c49aafe578dd94e6dd4f5b85a0aba739caa316c573fd64ef57f5fce584c6f41fcbc18b86efbc28f940c61567a61a9e1498d80d1dd91dc342138b64a59e96da2079fad89d180d0b0500919dd915ebb341c1a4199f6dcc789481ace5d1536236a5d2111d149ca8f246751f7f2121c2f71c99e954ec2e09722a4aa9a2ad9198e11a1a883dbda0b7b83cea73e0799b6068373a0431ccd2410b60a836a9f03e219499855b0b88daeb0b79b340dc8ff9168f92e82d0ea3489b78e07a9deb758d5ee7fc3fbe4295de8e2c7f2fa110cac7bdf957250d85b8c3f7f588ec7959a1a3e370a8d0eb93ee7e1e20419e8ef9855844da290352351003ec7bef34834a2e265091a8819b9a5b6fe2339b1e5fc2e131b43facee1fdfb8d6dec3261ed6a4465a3a288e84d26ff2c4e6fe936758b60fce7c11442da64a9c0afce7ce4cb903ac86c1555b455fcffe307e95ae068433029505d859e9beac4f4266aebb77891b73bf6e29f80012e07c2d2aeed75a9ad7d5ac684f1d0c31491ca0618b0576190a01dfce02ee3b71f5a7ba532b308b9b81ec18384fdae3bea76dee7d3352d055027c6293e7e452bea79a0a3f7e299a9fcaba1df0bbeab5c3198cb8b177d98396963e8c8e060d139f493f8dafa1fd39007bee5062e0263c9e626104abe704b46ded819924f16978585be471905821f4f32e0865d03c96ff92f8538fd8ed7d49e28109c5b49d26e1d6710a167f25f135a65156a8b857a782a4764576c12abb614e5207a3cf4f782eb62b25a6dc46a22680d56c57d8b945a9c37fff2df16d3433919886a6005db1a355515d14f6163b91c73acfb8f0343b20b3b19675edc2aad8ef47374479061df896c5660b6c571302b003c7f48b4eab0eeef76cc168168b5bfa0020c9b9c83958046b02a9a428cd236d0a39f9746d756f5f6281dfe05eb9463d3bd2f821778cb8206bb59acd713a33204"

  //zcash-cli getrawtransaction 67d5624898340dd823bf03593b0c1c7598d345ddb017ffd86a64e9b352570c5b
  val rawTxUnshield = "02000000004260900f000000000017a9145ec884891b57333468a44fd5c66b9f4551982af98730df1800000000001976a9144ff8319543581bad1a30d1dd76c04a9c3f4cfc7588ac50690f00000000001976a914f8889d41e2d066a2ba1cceb5031ae08ac67305eb88ac70ec1b00000000001976a914e44f5025f60ed4643cf155ea2486bbc8f04dba8688ac60b99a00000000001976a9149c4c45972b12da5e6fbb454e824ba40598a5695f88acd0831500000000001976a914d14b08621b46226e898a40e0f32122f319a14ef588ac509e1b00000000001976a914098ac94e00fb03ff62834bb9bea5d91e2e91a4c288ac50da1100000000001976a91423fbefa265899dcba70251e17bf4f9570811ef8588ace0c81000000000001976a914ae0e88becbefca163819d8bfe88d756fa743643288ac00171100000000001976a914c62cd5d58d1661d22e2e3a2577b6f9f51ed8792788ac80de0f00000000001976a914c43dbb280363780ac6b4d3ce3a403c256eac420e88ac50da1100000000001976a9148202ce4e82c2f6d1387491eb843e0f5fff5c208688ac70b70f00000000001976a91460ac3c51bcc3f4178d32e1c69ee7e1a39233375088ac70b70f00000000001976a914d845138c1473c4138026d3aa8d27113c2777885888ac50802000000000001976a9146fa5842fa8b4809b72ddb1b0be1650778eca79aa88ac70281200000000001976a914ef6e07c93dc57b251856b42e79e24c1ea0a0008088ac90051000000000001976a9143dfdf787aa6b296ff39d87e1d6f991072721ad3f88ac50690f00000000001976a914907d6654cd60258c0ae55740075834789725c05888ac00171100000000001976a9141162a9391516108ee210c818571f20596c7633ba88ac90c91900000000001976a914db9b2572be3ef5406562ef91b96df0d9fa0dadfb88ac30fd1300000000001976a91481bbbcd48e74056b7eeaadbc5e82e70ff53ed0cd88acb0531000000000001976a914c4223475e447a9ce58479e47692ed7ac6363199688aca09d1200000000001976a9144a5444b402a06bfb725886353f980672e431f39088ac70b70f00000000001976a9140d2f39a1da41e3651609a0f927e9fe543973fe7488ac80e4c520000000001976a914bc32211646a5350d2a35c518c0253a25e810aef288ac00171100000000001976a914959e0dea2ff7741b2ff02a2111d9ffdf5491c69888acb0531000000000001976a914dcd5c408d63f75eefb04e6833e4c5cdd1029ad0d88ac00102700000000001976a914dce8c61e93122180df33082eae5fff658788ba1488acf0ef1000000000001976a914ea4c01b4a3b5755cd4c0115011fc167bd533a6ed88acc07a1000000000001976a914026ab853a419e5830f0f5b4fbc9bcbfde863e45b88acf0ef1000000000001976a914fa339efed00fc6c48030ee15016cce1c6a2e06c388ac80079b00000000001976a914fad0cbe67ab737b9089a6b578354dfed076f4f5288acc07a1000000000001976a914b6e273b053e2038f251533d7b43443b470ab69da88ace0c81000000000001976a9144b6a50d365106853d2b0dd83c74e299dcc2c6d1d88ac00171100000000001976a914b703dbe19395797e50524260777c5025a7c71b1788ac50690f00000000001976a914905e8f4ad1847097cd4413d54b68a0a78ac7546688ac60900f00000000001976a914c748f31c62d0a9947b7cef4bf91b42425b8db70b88ac804f1200000000001976a9149ebcef3d75caa0f0eb264538f5e82a13944e462088ac90051000000000001976a914b6a2fcd9e1de40fe5d93effee2e6d32a5d96068d88ac70b70f00000000001976a9143e61df757d44c9d15ae72801578e31a2211acd8588ac70281200000000001976a9142fcce398d36c44a21336fdb66e8db14b85c16a0d88ac40420f00000000001976a91402bac9732f236305a83631884c00ae16f2f870ca88ac40b31100000000001976a91445467fe0192156f650875a88a1dccd855fb3d03288acf0601300000000001976a91442a73259cead322a98346d22e468395d609be55388ac804f1200000000001976a91448d9fb85246d56360ddd321f748613557d9c485888ac40420f00000000001976a91472ac96de0973995bea36554e908ca2950082814c88ac70281200000000001976a914b90f21db9a77c695f7ab1692de31b6343870579b88ac50f12200000000001976a9149e63431fd2ffa58d2d7ee8cf09b76066311ccf8788ac40420f00000000001976a914eb0c78c38bf0d49435dca40cdcbe52e28ad2386e88ac40420f00000000001976a914cce2051947f0dad2a5555f623c7c40109f3b915b88ace0d14d00000000001976a914475a4cbf4ab8c50816ddd6f4ef723980dd6a76ec88ac20651100000000001976a91473dc4e39acc25e7adeb6ce0e1e2dedc3062f018988ac50e34e00000000001976a914d0f57d867a3f22331b46c9289865ac80946892a688acf0ef1000000000001976a9149fca895a54b20f9c4a0884243d5b466deb9afb1188ac80de0f00000000001976a9147efbb84951ced5ebe59f3d2b744d62213ca75ea188ac80c01400000000001976a9141b2f202ca81df813da4aec59dca085edc08f8cfa88ac002e2200000000001976a9141a315fa40241a32ad82dede617fa4434ebba294488ac60900f00000000001976a91452ab92b0387a7572cbe15c8aaddf81f99bd6f0f388ac80841e00000000001976a91474f29e7abbd903d36f0a2394a3fee58acef8cddc88ac40420f00000000001976a914d068b76976faf9547068173484ca7b06f954545388ac70b70f00000000001976a91453f52d1964709f41e106ebbcf059d4052ec76a6f88ac60011200000000001976a914a951be319cba25724ba7d2c18df7b7c0af40bdb588ac103e1100000000001976a91478898a4489a32c1e7d460b9e1000ee4ae092763288ac20374207000000001976a914eb2376d99f066cf1ac716eb567cd4e026703804b88ace0391300000000001976a914c7033aabcb0dd83b01fa53e164a6b79b81c39bd688ac60900f00000000001976a914f5eb91a40a713a197fa8db7d3e3c5136c0de1bd788ac00000000010000000000000000803f4e2e000000002d45bac7b692e72276c815c47a25f6bfca2c37ebcaab7cec9530d0e5c219a8c0d10944368be8827e5a32655edb33a5874e6590740745aac7d6dbfdce029ae84f88ca1d1279fb4fcd1f9d916ed66a1b5320d70c5ada5ce920c5b3f385e9aa98380d3feb01258ccfbe267252961f0757cd3215042fabf1859ed8182388462a89d56d1b54cec91956f87ba77220f6f1f15d94cbec9d01d4d9f6282c1af33e854f3b553371d2bc1b5056ff7d6a1f6754c607469524000b98ffa5af90d778919842749ae608bf0617d57ed2af7392572e99a10abfc826b696504ba381bdac2eccc76d7b5cc665b0d1a8b5d46f864769a900f1f3502a25edaf004ece54793c9875f79f79509da92914203f32365b9af4c82f2c7b32d6198ab1e0199860210c451aee81022e7290a99cf9511c6f06bf69222fdaf4c0808813b6e5b96b7021b9eb0b482e68022952931e13875a5a7f1fd548f47ecbe4280007fe10d256164f1aa8d89cfdcce30a05c6452d205d5854db0e6590463fb3b3788232d932c86ac7c25757ea64b4587c994cea5152959b05f5d08728a07388e85801ffff1a7ed1ee8413d6ea47ab990d02044aba7358168ed9f5f7566082523f3c41ffc6cba9b4d72d0e3e100ad6abedd30327dea05d2cb28b1e16d34a9fd83ced86556b3ad7f6637a573b80972b9b2b2b62030fa5f08d2c04ca6d92a779daa81bc92edc0b5228dba0d4fe384c2baddebbd7620201b1d137b67752937b2006a9eb8c3908aae116c753d72a20630fe87b17233c4b031034c0eafdec17268b8b30c7122241e70c2aa04815224b0ecbf7a921e54116ca88893080b41f7cea529888f143f67a1b0c547ad1117b2e75626b2c56657e46088b3d5ecd812885c9dd57550c7e8b2be6087d672b4ec4704f13c074e4485e122471ac3f4dedf409ce5973705210f6d81e7d21d88780c127498264929b1c251671d59a5cf001056f8113c172ad9d552c8bc353a64fdecd8857998ec201ee32c2fc815ac1fc067934123954b063815a5e96b96833b396fc06cffe610ead2a96b13b916df85b4aea427cdea9aab5b2f8ddb13fb2d48ed6066dc4ea9e62c2824d6907484e65488be0f5fc7aab1a27e96cc9dcd096ab8051317dad65064fcab5e4b58a1b21c3bdb16f131f21a1bc56875b6966676a392b2f83c87e60b5b9401bd0230f64b86817cdba04cf3de9478e58d2a7f5dd8c05d1e088087ee12fd56444c25691d23b0ef10272a097fcfdbdb47727702d649848dbd6d696efd0e0929a79a9a8cdf7b37dbaa6f036440e61711bf8f0681001a2896e205c48b6877a658c8dc7bec6770663b93fb37231337cf74a0d1a8f6ad9e64ee09361be97eb9434ce1b5d326afa8280ba4035f595cabe52172818c34a1cf725b399c96c5dc92a3c0341919e10ba45270a55513507199d7c0161a903055676b74a21a42297397ca4df5eb909be09848b898c3dc9f6d16b3f33bc1e1d95ea5c0f71049a4aa2240266336fdf83a2f0293c8f4225053c8939eca6655640a476c7ecefda3d3118d41282c9f11e6ac80c0d20217f8a786b3e8746aac6613007338574688b4552c064bc6aa715a5dfd0019814f66e793c4d70504702bb5057f63da2ddd32196705f9c54a897300ad7d8c076abcb5c437e606fd6081f825fc6618a1929410d19cffec54c7278a14eefbbdd8302669f5ce463b0103e096e1398dfb6f1688f27c0b2580ff97fa129d7234140457349be26ef8242610e4bca573e5e3d2439a7980bdcf28e068b6d2f74c0bd952b2cd4f0f9df96a5ed6fbb9c3bd7ae4fa0c269b59f8a9893277282070d3aae32dbb28de7452d0b51101ce91521211ad46b06ae11e1316ecee07d5e2ebed45a225f383a6d7c9773546054455c5420997f9beeddb5069a3e17a9348dff9288670c9585e29fb6b1489c4cd4f03bbc7977d4dd56cf8859c6c7cebc7917b0fa7780ade091d45f6cf3f0d8e2f45fdda81eecbad4c59ebc0de0accb94c6be5f03b207b15d74be136e4b50b8a346c1d466e88eea6be8b0edacdb121800cdfa860870f8fe620a05e24157247d56e20539d12fc9ebaf87a5e37515c312c792e7bc0a3f3cb4577b6389cd768efe79e41882031672c1176e9df4f428fea3c8114db89f1909e3a13edb40dc759a0f78228a386a6b15b07af28af5f660949e8cb600580910c0529535bce4678da8ecf26698f1016464cd82f80f8d698737dc161b17de3f147e0f079d89fac3dbd1541ffba2dd9fc59e3b19688bd1b0148540a97e0b5f78bd69dd63244214d2989000d5439c604a4b7a6d97827f321160d49a50fbf7fa447a874ac7b852098d72526560cfeb3119fdd629c852d0d863058aee6b7ee4898f8912486b6f1dd58469398b2fd8f6d7edaca83f3949021596663db4fb844001acdb4feb765d71f23ad9b1f4251e0d02933c31503accf44a61a1e6f3a24707a5d207ceb2eb9dfd2a84abdd51ee9374dbf07756a4be51c6595ecd2f430c8f16a7362be4845396f2828b3e8d058db4cd49c69560f0925c5ec8add7225e72747b5cb6909992961ecf824cf89ced006712e48e9117a5b9756f8e9defcf9a54affb6fb141bcff831e49e6ccb3b30b41d3493d775be5e299b156ea99e7b412839eb7d9628c80f8a558dbd5591ccda211c80f799edd03460c"

  val encode = BitcoinSUtil.encodeHex(_: Seq[Byte])

  "RawZcashTransactionParser" must "parse a raw v1 transaction" in {
    val tx: ZcashTransaction = RawZcashTransactionParser.read(rawTxV1)
    tx.overwintered must be(false)
    tx.version must be(UInt32.one)
    tx.inputs.size must be(1)
    tx.outputs.size must be(2)
    tx.lockTime must be(UInt32.zero)
    tx.joinSplits.size must be(0)
    tx.txId.hex must be(BitcoinSUtil.flipEndianness("4070553dbcd801788e381692c8cf78cea3ed690ec93b359c5d91848dcc4e3a6c"))
  }

  it must "parse a raw v2 transaction" in {
    val tx: ZcashTransaction = RawZcashTransactionParser.read(rawTxV2)
    tx.overwintered must be(false)
    tx.version must be(UInt32(2))
    tx.inputs.size must be(1)
    tx.outputs.size must be(0)
    tx.lockTime must be(UInt32.zero)
    tx.joinSplits.size must be(1)
    tx.joinSplits.head.vpubOld must be(Satoshis(Int64(1001771776)))
    tx.joinSplits.head.vpubNew must be(Satoshis(Int64(0)))
    tx.txId.hex must be(BitcoinSUtil.flipEndianness("bf1706af01f60f5347eac2291358def1467cae709223018c0bfff38732390c67"))
  }

  it must "parse a raw v3 transaction" in {
    val tx: ZcashTransaction = RawZcashTransactionParser.read(rawTxV3)
    tx.overwintered must be(true)
    tx.version must be(UInt32(3))
    tx.inputs.size must be(5)
    tx.outputs.size must be(0)
    tx.lockTime must be(UInt32.zero)
    tx.expiryHeight must be(UInt32(126))
    tx.joinSplits.size must be(1)
    tx.joinSplits.head.vpubOld must be(Bitcoins(49.9999).satoshis)
    tx.joinSplits.head.vpubNew must be(Satoshis(Int64(0)))
    tx.txId.hex must be(BitcoinSUtil.flipEndianness("ec6711f8250e1f7972789c937220fc1171e9e93052fc6f0e8e4955f6b5a47530"))
  }

  it must "read and write a raw v1 tx" in {
    val tx = RawZcashTransactionParser.read(rawTxV1)
    val serializedTx = RawZcashTransactionParser.write(tx)
    encode(serializedTx) must be(rawTxV1)
  }

  it must "read and write a raw v2 tx" in {
    val tx = RawZcashTransactionParser.read(rawTxV2)
    val serializedTx = RawZcashTransactionParser.write(tx)
    encode(serializedTx) must be(rawTxV2)
  }

  it must "read and write a raw v3 tx" in {
    val tx = RawZcashTransactionParser.read(rawTxV3)
    val serializedTx = RawZcashTransactionParser.write(tx)
    encode(serializedTx) must be(rawTxV3)
  }

  it must "read/write this tx from regtest" in {
    val txId = BitcoinSUtil.flipEndianness("9cced130b9799995bcf848753192e5063004885e97eb9651ba75525f8a1c9f5f")
    val txHex = "01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff03510101ffffffff0200ca9a3b000000001976a914455a61c37227aa12b4fea74da5cb9e973c0c6ef088ac80b2e60e0000000017a9146708e6670db0b950dac68031025cc5b63213a4918700000000"
    val tx = RawZcashTransactionParser.read(txHex)
    txHex must be(tx.hex)
    tx.txId.hex must be(txId)
  }

  it must "read/write this tx on mainnet that unshields 66 utxos" in {
    val txIdBE = BEDoubleSha256Digest("67d5624898340dd823bf03593b0c1c7598d345ddb017ffd86a64e9b352570c5b")
    val tx = RawZcashTransactionParser.read(rawTxUnshield)
    tx.hex must be(rawTxUnshield)
    tx.txIdBE must be(txIdBE)
  }
}
